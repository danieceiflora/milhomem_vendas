<aside id="sidebar" class="fixed left-0 top-0 z-50 h-screen w-64 transform bg-gradient-to-b from-slate-950/90 to-blue-950/90 backdrop-blur-lg border-r border-border/40 transition-transform duration-300 ease-in-out md:translate-x-0 -translate-x-full md:z-40">
  <div class="flex h-full flex-col">
    <!-- Sidebar Header -->
    <div class="flex items-center justify-between p-4 border-b border-border/40">
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
          <i data-lucide="package" class="w-4 h-4 text-white"></i>
        </div>
        <span class="font-semibold text-sm text-primary">PINKMANIA</span>
      </div>
      <button id="sidebar-close" class="md:hidden p-1 text-muted-foreground hover:text-primary transition-colors rounded">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>

    <!-- Navigation Menu -->
    <nav class="flex-1 overflow-y-auto scrollbar-custom p-4" style="max-height: calc(100vh - 120px);">
      <ul class="space-y-2">
        <!-- Dashboard -->
        <li>
          <a href="{% url 'home' %}" class="group flex items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-accent hover:text-primary">
            <div class="flex h-6 w-6 items-center justify-center">
              <i data-lucide="layout-dashboard" class="h-4 w-4"></i>
            </div>
            <span>Dashboard</span>
          </a>
        </li>

        {% if perms.suppliers.view_supplier or perms.brands.view_brand or perms.categories.view_category or perms.products.view_product or perms.inflows.view_inflow %}
        <li>
          <button
            type="button"
            class="w-full group flex items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-accent hover:text-primary"
            data-sidebar-dropdown-toggle="inventory-menu"
          >
            <div class="flex h-6 w-6 items-center justify-center">
              <i data-lucide="boxes" class="h-4 w-4"></i>
            </div>
            <span class="flex-1 text-left">Estoque</span>
            <i data-lucide="chevron-down" class="h-4 w-4 transition-transform" data-dropdown-icon></i>
          </button>
          <div id="inventory-menu" class="mt-2 space-y-1 pl-8 hidden" data-sidebar-dropdown-content>
            {% if perms.suppliers.view_supplier %}
            <a href="{% url 'supplier_list' %}" class="group flex items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-accent hover:text-primary">
              <div class="flex h-6 w-6 items-center justify-center">
                <i data-lucide="truck" class="h-4 w-4"></i>
              </div>
              <span>Fornecedores</span>
            </a>
            {% endif %}
            {% if perms.brands.view_brand %}
            <a href="{% url 'brand_list' %}" class="group flex items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-accent hover:text-primary">
              <div class="flex h-6 w-6 items-center justify-center">
                <i data-lucide="badge" class="h-4 w-4"></i>
              </div>
              <span>Marcas</span>
            </a>
            {% endif %}
            {% if perms.categories.view_category %}
            <a href="{% url 'category_list' %}" class="group flex items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-accent hover:text-primary">
              <div class="flex h-6 w-6 items-center justify-center">
                <i data-lucide="tags" class="h-4 w-4"></i>
              </div>
              <span>Categorias</span>
            </a>
            {% endif %}
            {% if perms.products.view_product %}
            <a href="{% url 'product_list' %}" class="group flex items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-accent hover:text-primary">
              <div class="flex h-6 w-6 items-center justify-center">
                <i data-lucide="package" class="h-4 w-4"></i>
              </div>
              <span>Produtos</span>
            </a>
            {% endif %}
            {% if perms.inflows.view_inflow %}
            <a href="{% url 'inflow_list' %}" class="group flex items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-accent hover:text-primary">
              <div class="flex h-6 w-6 items-center justify-center">
                <i data-lucide="arrow-down-left" class="h-4 w-4"></i>
              </div>
              <span>Entradas</span>
            </a>
            {% endif %}
          </div>
        </li>
        {% endif %}

        {% if perms.customers.view_customer %}
        <li>
          <a href="{% url 'customer_list' %}" class="group flex items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-accent hover:text-primary">
            <div class="flex h-6 w-6 items-center justify-center">
              <i data-lucide="users" class="h-4 w-4"></i>
            </div>
            <span>Clientes</span>
          </a>
        </li>
        {% endif %}

        <!-- Divider -->
        <li>
          <div class="my-4 border-t border-border/40"></div>
        </li>

        <!-- PDV Dropdown -->
        <li>
          <button
            type="button"
            class="w-full group flex items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-accent hover:text-primary"
            data-sidebar-dropdown-toggle="pdv-menu"
          >
            <div class="flex h-6 w-6 items-center justify-center">
              <i data-lucide="store" class="h-4 w-4"></i>
            </div>
            <span class="flex-1 text-left">PDV</span>
            <i data-lucide="chevron-down" class="h-4 w-4 transition-transform" data-dropdown-icon></i>
          </button>
          <div id="pdv-menu" class="mt-2 space-y-1 pl-8 hidden" data-sidebar-dropdown-content>
            <a href="{% url 'pos:new' %}" class="group flex items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-accent hover:text-primary">
              <div class="flex h-6 w-6 items-center justify-center">
                <i data-lucide="shopping-cart" class="h-4 w-4"></i>
              </div>
              <span>Nova Venda</span>
            </a>
            <a href="{% url 'pos:sale_list' %}" class="group flex items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-accent hover:text-primary">
              <div class="flex h-6 w-6 items-center justify-center">
                <i data-lucide="list" class="h-4 w-4"></i>
              </div>
              <span>Histórico de Vendas</span>
            </a>
            {% if user.is_staff %}
            <a href="{% url 'pos:return_list' %}" class="group flex items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-accent hover:text-primary">
              <div class="flex h-6 w-6 items-center justify-center">
                <i data-lucide="rotate-ccw" class="h-4 w-4"></i>
              </div>
              <span>Devoluções</span>
            </a>
            {% endif %}
            <a href="{% url 'pos:ledger_list' %}" class="group flex items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-accent hover:text-primary">
              <div class="flex h-6 w-6 items-center justify-center">
                <i data-lucide="file-text" class="h-4 w-4"></i>
              </div>
              <span>Lançamentos</span>
            </a>
            <a href="{% url 'pos:payment_method_list' %}" class="group flex items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-accent hover:text-primary">
              <div class="flex h-6 w-6 items-center justify-center">
                <i data-lucide="credit-card" class="h-4 w-4"></i>
              </div>
              <span>Métodos de Pagamento</span>
            </a>
          </div>
        </li>

        
      </ul>
    </nav>

    <!-- Sidebar Footer -->
    <div class="border-t border-border/40 p-4">
      {% if user.is_authenticated %}
      <form action="{% url 'logout' %}" method="post" class="w-full">
        {% csrf_token %}
        <button type="submit" class="group flex w-full items-center space-x-3 rounded-lg px-3 py-2 text-sm font-medium text-muted-foreground transition-all duration-200 hover:bg-destructive hover:text-destructive-foreground">
          <div class="flex h-6 w-6 items-center justify-center">
            <i data-lucide="log-out" class="h-4 w-4"></i>
          </div>
          <span>Sair</span>
        </button>
      </form>
      {% endif %}
    </div>
  </div>
</aside>

<!-- Sidebar overlay for mobile -->
<div id="sidebar-overlay" class="fixed inset-0 z-40 bg-black/50 backdrop-blur-sm md:hidden hidden"></div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    const sidebarClose = document.getElementById('sidebar-close');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    
    // Function to open sidebar
    function openSidebar() {
      console.log('Opening sidebar'); // Debug
      sidebar.classList.remove('-translate-x-full');
      if (sidebarOverlay) {
        sidebarOverlay.classList.remove('hidden');
      }
    }
    
    // Function to close sidebar
    function closeSidebar() {
      console.log('Closing sidebar'); // Debug
      sidebar.classList.add('-translate-x-full');
      if (sidebarOverlay) {
        sidebarOverlay.classList.add('hidden');
      }
    }
    
    // Toggle sidebar for mobile
    if (mobileMenuToggle) {
      mobileMenuToggle.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Mobile menu toggle clicked'); // Debug
        if (sidebar.classList.contains('-translate-x-full')) {
          openSidebar();
        } else {
          closeSidebar();
        }
      });
    }
    
    // Close sidebar
    if (sidebarClose) {
      sidebarClose.addEventListener('click', function(e) {
        e.preventDefault();
        closeSidebar();
      });
    }
    
    // Close sidebar when clicking overlay
    if (sidebarOverlay) {
      sidebarOverlay.addEventListener('click', function() {
        closeSidebar();
      });
    }
    
    // Highlight active menu item
    const currentPath = window.location.pathname;
    const menuLinks = sidebar.querySelectorAll('a');
    
    menuLinks.forEach(link => {
      if (link.getAttribute('href') === currentPath) {
        link.classList.remove('text-muted-foreground');
        link.classList.add('bg-accent', 'text-primary', 'font-semibold');
      }
    });

    const dropdownToggles = sidebar.querySelectorAll('[data-sidebar-dropdown-toggle]');

    dropdownToggles.forEach(toggle => {
      const targetId = toggle.getAttribute('data-sidebar-dropdown-toggle');
      const content = document.getElementById(targetId);
      const icon = toggle.querySelector('[data-dropdown-icon]');

      if (!content) {
        return;
      }

      toggle.addEventListener('click', () => {
        content.classList.toggle('hidden');
        if (icon) {
          icon.classList.toggle('rotate-180');
        }
      });

      const containsActive = Array.from(content.querySelectorAll('a')).some(link => link.getAttribute('href') === currentPath);

      if (containsActive) {
        content.classList.remove('hidden');
        if (icon) {
          icon.classList.add('rotate-180');
        }
        toggle.classList.remove('text-muted-foreground');
        toggle.classList.add('bg-accent', 'text-primary', 'font-semibold');
      }
    });
  });
</script>
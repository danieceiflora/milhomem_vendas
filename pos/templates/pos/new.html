{% extends 'base.html' %}
{% load static %}

{% block title %}PDV - Ponto de Venda{% endblock %}

{% block page_title %}PDV - Venda #{{ sale.id }}{% endblock %}
{% block page_subtitle %}Sistema de vendas{% endblock %}

{% block content %}
<!-- Layout de 2 Colunas -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 h-[calc(100vh-160px)]">
  <!-- Coluna Esquerda: Cliente, Produtos e Pagamentos -->
  <div class="space-y-3 overflow-y-auto scrollbar-custom pr-2">
    <!-- Seleção de Cliente -->
    <div class="rounded-lg border border-border bg-card p-4">
      <div class="flex items-center space-x-2 mb-3">
        <div class="h-6 w-6 bg-primary/20 text-primary rounded flex items-center justify-center">
          <i data-lucide="user" class="h-3.5 w-3.5"></i>
        </div>
        <div>
          <h3 class="text-sm font-semibold">Cliente</h3>
        </div>
      </div>
      
      <div class="space-y-2">
        <div class="relative">
          <input
            type="text"
            placeholder="Buscar cliente..."
            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2"
            autocomplete="off"
            data-customer-search
          >
          <div
            class="absolute left-0 right-0 mt-2 max-h-64 overflow-y-auto rounded-md border border-border bg-card shadow-xl hidden z-10"
            data-customer-results
          ></div>
        </div>
        <div
          class="items-center justify-between rounded-lg border border-primary/20 bg-primary/10 p-3 hidden"
          data-customer-selected
        >
          <div>
            <p class="text-sm font-medium text-foreground" data-customer-name></p>
            <p class="text-xs text-muted-foreground" data-customer-details></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagamentos -->
    <div class="rounded-lg border border-border bg-card p-4">
      <div class="flex items-center space-x-2 mb-3">
        <div class="h-6 w-6 bg-primary/20 text-primary rounded flex items-center justify-center">
          <i data-lucide="credit-card" class="h-3.5 w-3.5"></i>
        </div>
        <div>
          <h3 class="text-sm font-semibold">Pagamentos</h3>
        </div>
      </div>

      <div class="space-y-2 mb-3">
        <select
          class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
          data-payment-method-select
        >
          <option value="">Selecione o método</option>
          {% for pm in payment_methods %}
          <option 
            value="{{ pm.id }}" 
            data-name="{{ pm.name }}"
            data-charge-percentage="{{ pm.charge_percentage }}"
            data-fee-payer="{{ pm.fee_payer }}"
          >
            {{ pm.name }}
            {% if pm.fee_percentage > 0 %}
              {% if pm.fee_payer == 'customer' %}
                (+ {{ pm.fee_percentage }}% taxa)
              {% else %}
                (↓ {{ pm.fee_percentage }}% desconto)
              {% endif %}
            {% endif %}
          </option>
          {% endfor %}
        </select>

        <div data-cash-fields class="hidden space-y-2">
          <label class="text-xs font-medium">Valor recebido</label>
          <input
            type="number"
            step="0.01"
            min="0"
            placeholder="0,00"
            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
            data-cash-tendered
          >
        </div>

        <div data-other-fields class="hidden space-y-2">
          <label class="text-xs font-medium">Valor do pagamento</label>
          <input
            type="number"
            step="0.01"
            min="0"
            placeholder="0,00"
            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
            data-payment-amount
          >
        </div>

        <button
          type="button"
          class="w-full inline-flex items-center justify-center space-x-2 bg-primary hover:bg-primary/90 text-primary-foreground px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 disabled:opacity-50"
          data-add-payment-btn
          disabled
        >
          <i data-lucide="plus" class="h-3.5 w-3.5"></i>
          <span>Adicionar Pagamento</span>
        </button>
      </div>

      <div data-payments-container>
        {% include 'pos/components/_payments_table.html' %}
      </div>
    </div>
    
    <!-- Botão Finalizar -->
    <div class="sticky bottom-0 bg-card/95 backdrop-blur-lg p-3 -mx-2 border-t border-border/40">
      <button
        type="button"
        class="w-full inline-flex items-center justify-center space-x-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white px-6 py-2.5 rounded-lg font-medium transition-all duration-200 shadow-lg hover:shadow-xl disabled:opacity-50"
        data-finalize-btn
      >
        <i data-lucide="check" class="h-4 w-4"></i>
        <span>Finalizar Venda</span>
      </button>
    </div>
  </div>
  
  <!-- Coluna Direita: Lista de Itens -->
  <div class="rounded-lg border border-border bg-card overflow-hidden flex flex-col h-full">
    <!-- Header fixo com busca de produtos -->
    <div class="border-b border-border/40 bg-gradient-to-r from-primary/10 to-secondary/10">
      <!-- Título e contador -->
      <div class="flex items-center justify-between px-3 py-2 border-b border-border/20">
        <div class="flex items-center space-x-2">
          <div class="h-6 w-6 bg-primary/20 text-primary rounded flex items-center justify-center">
            <i data-lucide="shopping-cart" class="h-3.5 w-3.5"></i>
          </div>
          <h3 class="text-sm font-semibold">Itens da Venda</h3>
        </div>
        <span class="text-xs font-medium text-muted-foreground px-2.5 py-1 bg-primary/20 rounded-full" data-items-count>0 itens</span>
      </div>
      
      <!-- Busca de produto integrada -->
      <div class="p-3 space-y-2">
        <div class="relative">
          <input
            type="text"
            placeholder="Buscar produto (código ou nome)..."
            class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2"
            autocomplete="off"
            data-product-search
          >
          <div
            class="absolute left-0 right-0 mt-2 max-h-64 overflow-y-auto rounded-md border border-border bg-card shadow-xl hidden z-10"
            data-product-results
          ></div>
        </div>
        <div class="flex space-x-2">
          <input
            type="number"
            min="1"
            value="1"
            placeholder="Qtd"
            class="flex h-8 w-16 rounded-md border border-input bg-background px-2 py-1 text-sm text-center"
            data-product-quantity
          >
          <button
            type="button"
            class="flex-1 inline-flex items-center justify-center space-x-1.5 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white px-3 py-1.5 rounded-md text-xs font-medium transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
            data-add-product-btn
            disabled
          >
            <i data-lucide="plus" class="h-3.5 w-3.5"></i>
            <span>Adicionar</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Container com scroll para os itens -->
    <div class="flex-1 overflow-y-auto scrollbar-custom p-3" data-items-container>
      {% include 'pos/components/_items_table.html' %}
    </div>
  </div>
</div>

<!-- Script para mostrar/ocultar resumo PDV -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const summaryBar = document.getElementById('pdv-summary-bar');
    if (summaryBar) {
      summaryBar.classList.remove('hidden');
      summaryBar.classList.add('flex');
    }
  });
</script>

<!-- Modal de Resolução de Diferença -->
<div id="diff-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50" data-diff-modal>
  <div class="bg-card rounded-lg p-6 max-w-md w-full mx-4">
    <h3 class="text-xl font-bold mb-4">Diferença de Pagamento</h3>
    <p class="text-muted-foreground mb-6" data-diff-message></p>
    <div class="space-y-3" data-diff-options></div>
    <button
      type="button"
      class="w-full mt-4 bg-secondary hover:bg-secondary/80 text-secondary-foreground px-4 py-2 rounded-lg font-medium"
      data-diff-cancel
    >
      Cancelar
    </button>
  </div>
</div>

<!-- Modal de Sucesso -->
<div id="success-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50" data-success-modal>
  <div class="bg-card rounded-lg p-6 max-w-md w-full mx-4 text-center">
    <div class="h-16 w-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
      <i data-lucide="check-circle" class="h-8 w-8 text-green-500"></i>
    </div>
    <h3 class="text-xl font-bold mb-2">Venda Finalizada!</h3>
    <p class="text-muted-foreground mb-6">A venda foi registrada com sucesso.</p>
    <button
      type="button"
      class="w-full bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-3 rounded-lg font-medium"
      onclick="window.location.reload()"
    >
      Nova Venda
    </button>
  </div>
</div>

{{ sale_data|json_script:"sale-data" }}
{{ payment_methods_data|json_script:"payment-methods-data" }}

<script src="{% static 'pos/pos.js' %}"></script>
{% endblock %}
